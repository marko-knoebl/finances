<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Finances</title>
    <script src="node_modules/kontojs/konto.js"></script>
    <script src="https://fb.me/react-15.1.0.js"></script>
    <script src="https://fb.me/react-dom-15.1.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script src="node_modules/papaparse/papaparse.js"></script>
  </head>

  <body>

    <style type="text/css">
      form {
        border: 1px solid black;
      }
    </style>

    <div id="finances-app"></div>
    <script>
      // global scope
      
      var uiData = {
        activeAccount: 'main',
        // is the "add account" ui visible?
        addAccountActive: false,
        addAccountType: 'bawagpsk',
        importActive: '',
      };
      var rerender;
      var dataset;
    </script>
    <script src="add-account-component.js"></script>
    <script type="text/babel">
      dataset = new konto.Dataset();
      dataset.addAccount({id: 'main', openDate: '2010-01-01'});
      dataset.addAccount({id: 'cash', openDate: '2010-01-01'});

      var addTransaction = function() {
        var amount = parseFloat(document.querySelector('#amount_input').value);
        if (amount >= 0) {
          var origin = 'world';
          var destination = 'main';
        } else {
          var origin = 'main';
          var destination = 'world';
        }
        origin = document.querySelector('#origin_account_select').value;
        destination = document.querySelector('#destination_account_select').value;
        var details = document.querySelector('#details_input').value;
        var date = document.querySelector('#date_input').value;
        dataset.addTransaction({
          amount: Math.abs(amount),
          origin: origin,
          destination: destination,
          details: details,
          date: date,
        });
        document.querySelector('#amount_input').value = '0';
        document.querySelector('#details_input').value = '';
        document.querySelector('#date_input').value = '';
        rerender();
      };

      var addRandomTransactionData = function() {
        var randomData = dataset.getRandomTransactionData(30);
        randomData.forEach(function(transaction) {
          dataset.addTransaction(transaction);
        });
        rerender();
      };

      var onAccountChange = function(event) {
        uiData.activeAccount = event.target.value;
        rerender();
      };

      var loadCsvFile = function(event) {
        var csvFile = document.querySelector('#csv_input').files[0];
        var currentBalance = parseFloat(document.querySelector('#current_balance_input').value);
        var encoding = konto.csvImportConfig[uiData.importActive].encoding;
        var reader = new FileReader();
        reader.onload = function(event) {
          var transactionData = konto.csvToKonto(event.target.result, uiData.importActive);
          transactionData.forEach(function(transaction) {
            if (transaction.amount < 0) {
              transaction.origin = 'main';
              transaction.destination = 'world';
              transaction.amount = Math.abs(transaction.amount);
            } else {
              transaction.origin = 'world';
              transaction.destination = 'main';
            }
            dataset.addTransaction(transaction);
          });
          dataset.setCurrentAccountBalance('main', currentBalance);
          uiData.importActive = '';
          rerender();
        };
        reader.readAsText(csvFile, encoding);
      };

      var activateImport = function(accountType) {
        uiData.importActive = accountType;
        rerender();
      };

      var inputForm = function(bankName) {
        return <form>
          <label for="current_balance_input">current balance:</label>
          <input type="number" step="0.01" id="current_balance_input"/><br/>
          <input type="file" id="csv_input"/><br/>
          <button type="button" onClick={loadCsvFile}>Load CSV</button>
        </form>
      };

      rerender = function() {
        ReactDOM.render(
          <div>
            <h1>Finances</h1>
            <div>
              <button onClick={showAddAccountDialog}>Add bank account</button>
              {uiData.addAccountActive ? addBankAccountUi(konto.csvImportConfig) : ''}
            </div>
            <div>
              <button onClick={function() {activateImport('bawagpsk')}}>Import BAWAG PSK</button>
              <button onClick={function() {activateImport('erstebank')}}>Import Erste Bank</button>
              <button onClick={function() {activateImport('raiffeisen')}}>Import Raiffeisen</button>
              <button onClick={function() {activateImport('easybank')}}>Import easybank</button>
              <button onClick={function() {activateImport('number26')}}>Import Number26</button>
              <button onClick={function() {activateImport('number26-de')}}>Import Number26 (de)</button>
              <button onClick={function() {activateImport('hellobank')}}>Import Hello Bank</button>
              <button onClick={function() {activateImport('paypal')}}>Import PayPal</button><br/>
              {uiData.importActive?inputForm(uiData.importActive):''}
            </div>
            <select name="account" value={uiData.activeAccount} onChange={onAccountChange}>
              {dataset.accounts.map(function(account) {
                return <option value={account.id}>{account.id}</option>
              })}
            </select>
            <div>
              Your account balance is: {dataset.getBalance('main').toFixed(2)}<br/>
              Your cash balance is: {dataset.getBalance('cash').toFixed(2)}<br/>
              Worlds balance is: {dataset.getBalance('world').toFixed(2)}
            </div>
            <div>
              <h2>Transactions</h2>
              {dataset.transactions.length === 0 ? 'no transactions' : ''}
              <table>
                <tbody>
                  {dataset.getTransactionsByAccount(uiData.activeAccount).reverse().map(function(transaction) {
                    if (transaction.origin === uiData.activeAccount) {
                      return <tr>
                        <td>-{transaction.amount.toFixed(2)}</td>
                        <td>{transaction.details}</td>
                        <td>{transaction.date}</td>
                        <td>{transaction.origin}</td>
                        <td>{transaction.destination}</td>
                      </tr>;
                    } else {
                      return <tr>
                        <td>{transaction.amount.toFixed(2)}</td>
                        <td>{transaction.details}</td>
                        <td>{transaction.date}</td>
                        <td>{transaction.origin}</td>
                        <td>{transaction.destination}</td>
                      </tr>;
                    }
                  })}
                </tbody>
              </table>
            </div>
            <div>
              <input id="amount_input" type="number" step="0.01"></input>
              <input id="details_input"></input>
              <input id="date_input" type="date"></input>
              <select id="origin_account_select" name="origin_account" value={uiData.originAccount}>
                {dataset.accounts.map(function(account) {
                  return <option value={account.id}>{account.id}</option>
                })}
              </select>
              <select id="destination_account_select" name="destination_account" value={uiData.destinationAccount}>
                {dataset.accounts.map(function(account) {
                  return <option value={account.id}>{account.id}</option>
                })}
              </select>
              <button onClick={addTransaction}>Add Transaction</button>
            </div>
            <button onClick={addRandomTransactionData}>Add random Transactions</button>
          </div>,
          document.getElementById('finances-app')
        );
      };
      rerender();
    </script>
  </body>
</html>
