<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Finances</title>
    <script src="https://rawgit.com/marko-knoebl/kontojs/master/konto.js"></script>
    <script src="https://fb.me/react-15.1.0.js"></script>
    <script src="https://fb.me/react-dom-15.1.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script src="node_modules/papaparse/papaparse.js"></script>
  </head>

  <body>

    <style type="text/css">
      form {
        border: 1px solid black;
      }
    </style>

    <div id="finances-app"></div>
    <script>
      // global scope
      
      var uiData = {
        activeAccount: 'main',
        importActive: '',
        activeAccount: 'world',
        addAccount: {
          // is the "add account" ui visible?
          active: false,
          type: 'bawagpsk',
          name: 'Bawag PSK'
        }
      };
      var rerender;
      var dataset;
    </script>
    <script src="add-account-component.js"></script>
    <script src="active-account-details.js"></script>
    <script src="transaction-list.js"></script>
    <script src="account-overview.js"></script>
    <script type="text/babel">
      dataset = new konto.Dataset();
      dataset.addAccount({id: 'main', openDate: '2010-01-01'});
      dataset.addAccount({id: 'cash', openDate: '2010-01-01'});

      var addTransaction = function() {
        var amount = parseFloat(document.querySelector('#amount_input').value);
        if (amount >= 0) {
          var origin = 'world';
          var destination = 'main';
        } else {
          var origin = 'main';
          var destination = 'world';
        }
        origin = document.querySelector('#origin_account_select').value;
        destination = document.querySelector('#destination_account_select').value;
        var details = document.querySelector('#details_input').value;
        var date = document.querySelector('#date_input').value;
        dataset.addTransaction({
          amount: Math.abs(amount),
          origin: origin,
          destination: destination,
          details: details,
          date: date,
        });
        document.querySelector('#amount_input').value = '0';
        document.querySelector('#details_input').value = '';
        document.querySelector('#date_input').value = '';
        rerender();
      };

      var addRandomTransactionData = function() {
        var randomData = dataset.getRandomTransactionData(30);
        randomData.forEach(function(transaction) {
          dataset.addTransaction(transaction);
        });
        rerender();
      };

      var onAccountChange = function(event) {
        uiData.activeAccount = event.target.value;
        rerender();
      };

      var activateImport = function(accountType) {
        uiData.importActive = accountType;
        rerender();
      };

      rerender = function() {
        ReactDOM.render(
          <div>
            <h1>Finances</h1>
            {accountOverview()}
            <div>
              <button onClick={showAddAccountDialog}>Add bank account</button>
              {uiData.addAccount.active ? addBankAccountUi(konto.csvImportConfig) : ''}
            </div>
            <select name="account" value={uiData.activeAccount} onChange={onAccountChange}>
              {dataset.accounts.map(function(account) {
                return <option value={account.id}>{account.id}</option>
              })}
            </select>
            <h2>Add Transaction</h2>
            <div>
              <input id="amount_input" type="number" step="0.01"></input>
              <input id="details_input"></input>
              <input id="date_input" type="date"></input>
              <select id="origin_account_select" name="origin_account" value={uiData.originAccount}>
                {dataset.accounts.map(function(account) {
                  return <option value={account.id}>{account.id}</option>
                })}
              </select>
              <select id="destination_account_select" name="destination_account" value={uiData.destinationAccount}>
                {dataset.accounts.map(function(account) {
                  return <option value={account.id}>{account.id}</option>
                })}
              </select>
              <button onClick={addTransaction}>Add Transaction</button>
            </div>
            <button onClick={addRandomTransactionData}>Add random Transactions</button>
            <div>
              <h2>Active Account</h2>
              details: {JSON.stringify(dataset.getAccount({id: uiData.activeAccount}))}<br/>
              {activeAccountDetails(uiData.activeAccount)}
              <h3>Transaction List</h3>
              {transactionList(uiData.activeAccount)}
            </div>
          </div>,
          document.getElementById('finances-app')
        );
      };
      rerender();
    </script>
  </body>
</html>
